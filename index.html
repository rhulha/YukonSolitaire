<html>
<head>
	<style>
	body {
		background-color: green;
	}
	.card {
		background-color: white;
		border-radius: 15px;
		border: 1px solid black;
		position: absolute;
		width: 140px;
		height: 220px;
		user-select: none;
		cursor: default;
	}
	.red {
		color: red;
	}
	.black {
		color: black;
	}
	.topLeft {
		position: absolute;
		font-size: 60px;
		left: 12px;
	}
	.topRight {
		position: absolute;
		font-size: 60px;
		right: 12px;
	}
	.suit {
		font-size: 150px;
	}
	.backside {
		background-color: lightblue;
	}
	.hidden {
		display: none;
	}
	</style>
</head>
<body>

<div class="card backside">
	<span class="topLeft hidden"></span>
    <span class="topRight hidden"></span>
	<br/>
	<span class="suit hidden"></span>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>

<script>
	// http://labs.mintchaos.com/flippant.js/
	document.addEventListener('mousedown', function(e){e.preventDefault()}, false);
	
	function shuffle(a) {
		for (var i = a.length - 1; i > 0; i--) {
			var j = Math.floor(Math.random() * (i + 1));
			var temp = a[i];a[i] = a[j];a[j] = temp;
		}
		return a;
	}
	$(function() {
		var suitList = ['&clubs;', '&spades;', '&hearts;', '&diams;'];
		var colorList = ['black', 'black', 'red', 'red'];
		var pics = ['J', 'Q', 'K'];
		
		function cloneDeckFromBaseCard( baseCard ) {
			var cards = [];
			for( var suit=0; suit<4; suit++) {
				for( var value=1; value<14; value++) {
					var card = baseCard.cloneNode(true);
					card.id = 'id_'+suit+'_'+value;
					card.setAttribute('suit', suit);
					card.setAttribute('value', value);
					var spans = $(card).children('span');
					$(spans[0]).html(value == 1 ? 'A' : (value>10?pics[value-11]:value));
					$(spans[1]).html(suitList[suit]);
					$(spans[2]).html(suitList[suit]);
					document.body.appendChild( card);
					cards.push( card);
				}
			}
			return cards;
		}
		
		function setupDraggable() {
			$('.card').draggable({
				disabled: true,
				revert: 'invalid',
				start: function(e) {
					console.log( 'start', e.target.getAttribute('value') );
				},
				drag: function(e, ui) {
					// $('#block2').css('left',$(this).position().left);  
					$('.below').css({
						'top': ui.helper.css('top'),
						'left': ui.helper.css('left')
					});
				},
				stop: function(e) {
					//console.log(e);
				}
			});
			$('.card').droppable({
				disabled: true,
				accept: dropHandler
			});
		}
		
		function dropHandler(dropCard) {
			var dropColor = dropCard[0].getAttribute('suit') < 2;
			var targetColor = this.getAttribute('suit') < 2;
			
			var dropValue = parseInt(dropCard[0].getAttribute('value'));
			var targetValue = parseInt( this.getAttribute('value'));
			if( targetValue == NaN)
				return false;

			return (dropColor !== targetColor) && (targetValue === dropValue + 1);
			
			//dropElem was the dropped element, return true or false to accept/refuse it
		}

		function reveal(card) {
			var c = colorList[card.getAttribute('suit')];
			$(card).removeClass('backside');
			$(card).children('span').removeClass('hidden').addClass(c);
		}

		function setupBoard() {
			var board = [];
			reveal(cards[0]);
			board[0] = [cards[0]];

			var counter=1;
			for( var col=1; col<7; col++) {
				board[col] = [];
				for( var row=0; row<5+col; row++) {
					var card = cards[counter++];
					if( row > col -1 )
						reveal( card);
					board[col].push(card);
				}
			}
			return board;
		}

		function printBoard( board) {
			var xPos=100;
			for( var col=0; col<board.length; col++) {
				var yPos=80;
				for( var row=0; row<board[col].length; row++) {
					// TODO: put the jQuery wrapped card into the board...
					var card = board[col][row];
					
					$(card).css({
						left: xPos+'px',
						top: yPos+'px',
						zIndex: row
					});

					if( ! $(card).hasClass('backside') ) {
						$(card).draggable({disabled: false});
						yPos+=65;
					} else {
						yPos+=10;
					}
					
					if( row == board[col].length-1 ) {
						$(card).droppable({disabled: false});
					} else {
						$(card).droppable({disabled: true});
					}
					
				}
				xPos+=200
			}
		}

		var baseCard = document.getElementsByClassName('card')[0];
		var cards = cloneDeckFromBaseCard( baseCard);
		$(baseCard).hide();
		shuffle( cards);
		setupDraggable();
		var board = setupBoard();
		printBoard( board);
		
	});
</script>
  
</body>
</html>

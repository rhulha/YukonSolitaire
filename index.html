<!DOCTYPE HTML>
<html>
<head>
	<style>
	.baseShape {
		height: 220px;
		width: 140px;
		border-radius: 15px;
		border: 1px white solid;
		position: absolute;
	}
	.tableau {
		margin-left: 60px;
		margin-top: 10px;
		float: left;
		position:relative;
	}
	.card {
		background-color: white;
		border: 1px black solid;
		user-select: none;
		cursor: default;
		left:-1px;
		top: -1px;
	}
	.topLeft {
		position: absolute;
		font-size: 60px;
		left: 12px;
	}
	.topRight {
		position: absolute;
		font-size: 60px;
		right: 12px;
	}
	.suit {
		font-size: 150px;
		margin-left: 10px;
	}
	.backside {
		background-color: lightblue;
	}
	span {
		pointer-events: none
	}
	</style>
</head>
<body style="background-color:green">

<div class="baseShape tableau"></div>
<div class="baseShape tableau"></div>
<div class="baseShape tableau"></div>
<div class="baseShape tableau"></div>
<div class="baseShape tableau"></div>
<div class="baseShape tableau"></div>
<div class="baseShape tableau"></div>

<div class="baseShape card backside">
	<span class="topLeft" style="display: none"></span>
    <span class="topRight" style="display: none"></span>
	<br/>
	<span class="suit" style="display: none"></span>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>

<script>
	function shuffle(a) {
		for (var i = a.length - 1; i > 0; i--) {
			var j = Math.floor(Math.random() * (i + 1));
			var temp = a[i];a[i] = a[j];a[j] = temp;
		}
	}
	$(function() {
		var suitList = ['&clubs;', '&spades;', '&hearts;', '&diams;'];
		var colorList = ['black', 'black', 'red', 'red'];
		var pics = ['J', 'Q', 'K'];
		
		function cloneDeckFromBaseCard( baseCard ) {
			var cards = [];
			for( var suit=0; suit<4; suit++) {
				for( var value=1; value<14; value++) {
					var card = baseCard.clone();
					card.attr({
						id: 'id_'+suit+'_'+value,
						suit: suit,
						value: value
					});
					var spans = card.children('span');
					spans.eq(0).html(value == 1 ? 'A' : (value>10?pics[value-11]:value));
					spans.eq(1).html(suitList[suit]);
					spans.eq(2).html(suitList[suit]);
					cards.push( card);
				}
			}
			return cards;
		}
		
		function reveal(card) {
			var c = colorList[card.attr('suit')];
			card.removeClass('backside');
			card.children('span').css({color: c, display: ''});
		}

		function setupBoard(cards) {
			reveal(cards[0]);
			var tableaus = $('.tableau');
			
			tableaus.eq(0).append(cards[0]);

			var counter=1;
			for( var col=1; col<7; col++) {
				for( var row=0; row<5+col; row++) {
					var card = cards[counter++];
					if( row > col -1 )
						reveal( card);
					var tableau = tableaus.eq(col);
					if( tableau.children().length == 0) {
						tableau.append(card);
					} else {
						tableau.find('.card').last().append( card);
						card.css('top', '20px');
					}
					if( row > col ) {
						card.css('top', '66px');
					}
				}
			}
		}
		
		var md = false;
		var mdTarget, mdTargetPos, mdPageX, mdPageY;

		$(document).mousedown( function(e) {
			mdTarget = $(e.target);
			
			if( !mdTarget.hasClass('card')) {
				mdTarget = mdTarget.parent();
			}
			
			if( mdTarget.hasClass('card') && !mdTarget.hasClass('backside')) {
				mdTargetPos = mdTarget.position();
				mdPageX = e.pageX;
				mdPageY = e.pageY;
				md = true;
				mdTarget.css('pointer-events', 'none');
			}
			e.preventDefault();
		});

		$(document).mouseup( function(e){
			if( md) {
				md = false;
				var dropCard = $(e.target);
				if( dropHandler(mdTarget, dropCard)) {
					dropCard.append( mdTarget);
				}
				mdTarget.css({
					top: mdTargetPos.top,
					left: mdTargetPos.left,
					pointerEvents: 'auto'
				});
			}
		});

		$(document).mousemove( function(e) {
			if( md) {
				mdTarget.css({
					top: mdTargetPos.top + e.pageY - mdPageY,
					left: mdTargetPos.left + e.pageX - mdPageX
				});
			}
		});
		
		function dropHandler( dragCard, dropCard) {
			var dropColor = dropCard.attr('suit') < 2;
			var dragColor = dragCard.attr('suit') < 2;
			
			var dropValue = parseInt( dropCard.attr('value'));
			var dragValue = parseInt( dragCard.attr('value'));
			if( dragValue == NaN)
				return false;
			return (dropColor !== dragColor) && (dropValue === dragValue + 1);
		}


		var baseCard = $('.card').first();
		var cards = cloneDeckFromBaseCard( baseCard);
		$(baseCard).hide();
		shuffle( cards);
		setupBoard(cards);
		
	});
</script>
  
</body>
</html>
